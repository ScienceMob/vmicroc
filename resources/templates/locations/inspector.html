{% extends base_template %}
{% block inspector-active %} class="active"{% endblock %}
{% block extra_head %}
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
<script src="http://dygraphs.com/dygraph-combined.js"></script>

{% endblock %}
{% block content %}
<div class="container">
    <div class="row">
        <div class="span8" id="location-instruction">
            <h2>Select your site</h2>
        </div>
        <div class="span8" id="location-detail">
            <h2 id="location-name"></h2>
            <h3 id="location-message"></h3>
            <div id="chart-summary-canvas" class="chart"></div>
            <h3 id="detail-message"></h3>
            <div id="chart-detail-canvas" class="chart"></div>
        </div>
        <div class="span4" id="map-canvas"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
var map;
var summaryChart;

function render_detail(location_id, timestamp) {
  $('#detail-message').text('Loading...').show();
  $('#chart-detail-canvas').hide();
  $.ajax({
    url: '/location/' + location_id + '/detail/',
    cache: false,
    success: function(data) {
      $('#detail-message').hide();
      $('#chart-detail-canvas').show();
      summaryChart = new Dygraph(
        document.getElementById("chart-detail-canvas"),
        data,
        {
          title: 'Daily Temperatures - Detailed data, ' + timestamp,
          ylabel: 'Temperature (C)',
          legend: 'always',
          labelsDivStyles: {
            textAlign: 'right'
          },
        }
      );
    },
    error: function () {
      $('#location-message').text('Problem loading location data.');
    }
  });
}

function render_location_callback(location_name, location_id) {
  var render_location = function() {
    $('#location-instruction').hide();
    $('#location-name').text(location_name);
    $('#location-message').text('Loading...').show();
    $('#location-detail').show();
    $('#chart-summary-canvas').hide();
    $('#detail-message').hide();
    $('#chart-detail-canvas').hide();

    $.ajax({
      url: '/location/' + location_id + '/summary/',
      cache: false,
      success: function(data) {
        $('#location-message').hide();
        $('#chart-summary-canvas').show();
        $('#detail-message').text('Click on the chart to view detailed data for that date').show();

        summaryChart = new Dygraph(
          document.getElementById("chart-summary-canvas"),
          data,
          {
            customBars: true,
            title: 'Daily Temperatures - Trend data',
            ylabel: 'Temperature (C)',
            legend: 'always',
            labelsDivStyles: {
              textAlign: 'right'
            },
            clickCallback: function (e, x, points) {
              render_detail(location_id, x);
            },
            showRangeSelector: true
          }
        );
      },
      error: function () {
        $('#location-message').text('Problem loading location data.');
      }
    });
  };
  return render_location;
}

function initialize() {
  var mapOptions = {
    zoom: 8,
    center: new google.maps.LatLng(-37.1, 140.0),
    mapTypeId: google.maps.MapTypeId.ROADMAP
  };
  map = new google.maps.Map(document.getElementById('map-canvas'),
      mapOptions);

  {% for location in locations %}
  var marker = new google.maps.Marker({
      position: new google.maps.LatLng({{ location.latitude }}, {{ location.longitude }}),
      map: map,
    });

  google.maps.event.addListener(marker, 'click', render_location_callback('{{ location.name }}', {{ location.id }}));
  {% endfor %}
}

google.maps.event.addDomListener(window, 'load', initialize);



{% endblock %}